{% extends "inventory/base.html" %}
{% load humanize %}

{% block content %}
<!-- HERO STATS -->
<div class="rounded-4 p-4 mb-4" style="background:linear-gradient(135deg,#111,#1a1a2e);">
    <div class="row text-center">
        <div class="col-4">
            <div class="fw-bold fs-3" style="color:#FFD700;">{{ total_results }}</div>
            <div class="text-white-50 small">V√©hicules</div>
        </div>
        <div class="col-4">
            <div class="fw-bold fs-3" style="color:#FFD700;"><i class="bi bi-shield-check"></i></div>
            <div class="text-white-50 small">V√©rifi√©s</div>
        </div>
        <div class="col-4">
            <div class="fw-bold fs-3" style="color:#FFD700;"><i class="bi bi-geo-alt"></i></div>
            <div class="text-white-50 small">Cameroun</div>
        </div>
    </div>
</div>

<!-- SEARCH -->
<div class="bg-white rounded-4 shadow-sm p-4 mb-4 border">
    <form method="GET" action="{% url 'home' %}">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-search text-muted"></i></span>
            <input type="text" name="q" class="form-control border-start-0 py-3" placeholder="Rechercher par marque, mod√®le, ville..." value="{{ query|default:'' }}">
            <button class="btn btn-primary px-4 fw-semibold rounded-end-3" type="submit">Rechercher</button>
        </div>

        <div class="text-center mt-3">
            <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-4" data-bs-toggle="collapse" data-bs-target="#filters">
                <i class="bi bi-sliders me-1"></i> Filtres avanc√©s
            </button>
        </div>

        <div class="collapse {% if fuel or transmission or price_min or price_max or year_min or year_max or selected_city %}show{% endif %}" id="filters">
            <div class="bg-light rounded-4 p-4 mt-3 border">
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Carburant</label>
                        <select name="fuel" class="form-select">
                            <option value="">Tous</option>
                            {% for val, lbl in fuel_choices %}
                            <option value="{{ val }}" {% if fuel == val %}selected{% endif %}>{{ lbl }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Transmission</label>
                        <select name="transmission" class="form-select">
                            <option value="">Toutes</option>
                            {% for val, lbl in transmission_choices %}
                            <option value="{{ val }}" {% if transmission == val %}selected{% endif %}>{{ lbl }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Prix min</label>
                        <input type="number" name="price_min" class="form-control" placeholder="0" value="{{ price_min }}">
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Prix max</label>
                        <input type="number" name="price_max" class="form-control" placeholder="‚àû" value="{{ price_max }}">
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Ann√©e min</label>
                        <input type="number" name="year_min" class="form-control" placeholder="2000" value="{{ year_min }}">
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Ann√©e max</label>
                        <input type="number" name="year_max" class="form-control" placeholder="2026" value="{{ year_max }}">
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label small fw-bold text-uppercase text-secondary">Ville</label>
                        <select name="city" class="form-select">
                            <option value="">Toutes</option>
                            {% for c in available_cities %}
                            <option value="{{ c }}" {% if selected_city == c %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-6 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-dark rounded-pill flex-fill"><i class="bi bi-funnel-fill me-1"></i> Filtrer</button>
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary rounded-pill"><i class="bi bi-x-lg"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- RESULTS COUNT -->
<p class="text-muted small mb-3">
    <strong class="text-primary">{{ total_results }}</strong> v√©hicule{{ total_results|pluralize }} trouv√©{{ total_results|pluralize }}{% if query %} pour ¬´ <strong>{{ query }}</strong> ¬ª{% endif %}
</p>

<!-- CAR GRID -->
<div class="row g-4">
    {% for car in cars %}
    <div class="col-lg-4 col-md-6">
        <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden" style="transition:transform .3s,box-shadow .3s;" onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 12px 40px rgba(0,0,0,.12)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
            <!-- IMAGE -->
            <div class="position-relative overflow-hidden" style="height:220px;">
                {% if car.image %}
                <img src="{{ car.image.url }}" alt="{{ car.brand }} {{ car.model }}" class="w-100 h-100" style="object-fit:cover;" loading="lazy">
                {% else %}
                <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center">
                    <i class="bi bi-car-front text-muted" style="font-size:3rem;"></i>
                </div>
                {% endif %}

                {% if user.is_authenticated %}
                <a href="{% url 'toggle_favorite' car.id %}" class="position-absolute top-0 end-0 m-3 d-flex align-items-center justify-content-center rounded-circle text-white text-decoration-none" style="width:38px;height:38px;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);font-size:1.1rem;">
                    <i class="bi {% if car.id in user_favorites %}bi-heart-fill text-danger{% else %}bi-heart{% endif %}"></i>
                </a>
                {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="position-absolute top-0 end-0 m-3 d-flex align-items-center justify-content-center rounded-circle text-white text-decoration-none" style="width:38px;height:38px;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);font-size:1.1rem;" title="Connexion requise">
                    <i class="bi bi-heart"></i>
                </a>
                {% endif %}
            </div>

            <!-- BODY -->
            <div class="card-body p-3">
                <h5 class="fw-bold mb-2" style="font-size:1.05rem;">{{ car.brand }} {{ car.model }}</h5>

                <div class="d-flex flex-wrap gap-1 mb-3">
                    <span class="badge bg-light text-dark border small">üìÖ {{ car.year }}</span>
                    <span class="badge bg-light text-dark border small">üõ£Ô∏è {{ car.kilometrage|intcomma }} km</span>
                    <span class="badge bg-light text-dark border small">‚õΩ {{ car.fuel }}</span>
                </div>

                <div class="mb-2">
                    <span class="fw-bold fs-5 text-primary">{{ car.price|intcomma }}</span>
                    <span class="text-muted small">FCFA</span>
                </div>

                {% if car.description %}
                <p class="text-muted small mb-0" style="line-height:1.5;">{{ car.description|truncatewords:12 }}</p>
                {% endif %}
            </div>

            <!-- FOOTER -->
            <div class="card-footer bg-white border-0 p-3 pt-0">
                <div class="d-flex gap-2">
                    <a href="{% url 'car_detail' car.id %}" class="btn btn-dark flex-fill rounded-3 fw-semibold">
                        <i class="bi bi-arrow-right-circle me-1"></i> Consulter
                    </a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'add_to_compare' car.id %}" class="btn btn-outline-primary rounded-3 px-3" title="Comparer">
                        <i class="bi bi-arrow-left-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% empty %}
    <div class="col-12 text-center py-5">
        <i class="bi bi-car-front text-muted" style="font-size:4rem;"></i>
        <h4 class="text-muted mt-3">Aucun v√©hicule trouv√©</h4>
        <p class="text-muted">Essayez d'ajuster vos filtres ou revenez bient√¥t !</p>
        <a href="{% url 'home' %}" class="btn btn-primary rounded-pill px-4 mt-2">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Voir tout le catalogue
        </a>
    </div>
    {% endfor %}
</div>

<!-- PAGINATION -->
{% if page_obj.has_other_pages %}
<div class="d-flex justify-content-center mt-5">
    <nav>
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link rounded-3 me-1" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fuel %}&fuel={{ fuel }}{% endif %}{% if transmission %}&transmission={{ transmission }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link rounded-3 mx-1" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if fuel %}&fuel={{ fuel }}{% endif %}{% if transmission %}&transmission={{ transmission }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}">
                    {{ num }}
                </a>
            </li>
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link rounded-3 ms-1" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fuel %}&fuel={{ fuel }}{% endif %}{% if transmission %}&transmission={{ transmission }}{% endif %}{% if price_min %}&price_min={{ price_min }}{% endif %}{% if price_max %}&price_max={{ price_max }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
{% endblock %}